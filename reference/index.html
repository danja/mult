<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="viewport-fit=cover,width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>Neon Multiverse ‚Äî Mobile Optimized</title>
<style>
  :root{--pill-bg:rgba(0,0,0,.55);--pill-br:rgba(255,255,255,.22);--btn-bg:rgba(255,255,255,.12);--btn-bg-on:rgba(255,255,255,.28);--btn-br:rgba(255,255,255,.25)}
  html,body{height:100%}
  body{margin:0;overflow:hidden;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;background:radial-gradient(1200px 1200px at 10% 10%,#0f172a 0%,#020617 40%),linear-gradient(135deg,#1e293b 0%,#0b1020 100%);color:#fff}
  #canvas-container{position:relative;width:100vw;height:100vh;touch-action:none}
  #info{position:fixed;top:env(safe-area-inset-top,10px);right:env(safe-area-inset-right,10px);background:rgba(0,0,0,.72);border-radius:12px;backdrop-filter:blur(10px);width:300px;box-shadow:0 4px 20px rgba(0,0,0,.3);z-index:1000;transition:.25s}
  #info.collapsed{width:48px;height:48px;opacity:.95}
  #info-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px}
  #info-content{padding:0 14px 14px;max-height:60vh;overflow:auto;transition:max-height .25s}
  #info.collapsed #info-content{max-height:0;padding:0;overflow:hidden}
  .button-group{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid var(--btn-br);background:var(--btn-bg);color:#fff;border-radius:18px;padding:8px 12px;font-size:11px;font-weight:600;line-height:1;cursor:pointer}
  .btn[aria-pressed="true"]{background:var(--btn-bg-on)}
  .layer-item{display:flex;align-items:center;justify-content:space-between;margin:6px 0;font-size:11px}
  .layer-left{display:flex;align-items:center;gap:8px}
  .layer-color{width:16px;height:16px;border-radius:3px;box-shadow:0 2px 5px rgba(0,0,0,.2)}
  .label3d{position:absolute;color:#fff;font-size:12px;text-shadow:0 0 4px rgba(0,0,0,.85),0 0 8px rgba(0,0,0,.65);pointer-events:none;user-select:none;white-space:nowrap;font-weight:700}
  .edge-pill{padding:4px 8px;border-radius:999px;background:var(--pill-bg);border:1px solid var(--pill-br)}
  .edge-pill .arrow{opacity:.95;padding:0 2px}
  #tooltip{position:absolute;padding:8px 12px;background:rgba(0,0,0,.9);color:#fff;border-radius:6px;font-size:12px;pointer-events:none;display:none;z-index:1000;backdrop-filter:blur(10px);box-shadow:0 2px 10px rgba(0,0,0,.3)}
  @media(max-width:768px){#info{width:260px}.btn{font-size:10px;padding:7px 10px}}
</style>
</head>
<body>
  <div id="canvas-container"></div>

  <div id="info">
    <div id="info-header">
      <h3 class="title" style="margin:0;font-size:14px">Neon Multiverse (RDF-ish, mobile-tuned)</h3>
      <button id="collapseBtn" class="btn" aria-pressed="false">‚ñæ</button>
    </div>
    <div id="info-content">
      <div class="button-group">
        <button id="animBtn" class="btn" aria-pressed="true">‚èØÔ∏è Anim</button>
        <button id="labelsBtn" class="btn" data-mode="smart" aria-pressed="true">üè∑Ô∏è Labels: Smart</button>
        <button id="topBtn" class="btn">‚åÇ Top</button>
        <button id="resetBtn" class="btn">üéØ Reset</button>
        <button id="perfBtn" class="btn" aria-pressed="true">‚ö° Perf</button>
      </div>
      <p style="margin:.4rem 0 .7rem 0"><b>Touch:</b> 1-finger orbit ‚Ä¢ 2-finger pinch to zoom.</p>
      <div class="layer-legend"></div>
      <label style="display:flex;gap:.5rem;align-items:center;margin-top:.5rem">
        <input type="checkbox" id="toggle-vertical" checked/> <span>Show shared connectors</span>
      </label>
    </div>
  </div>

  <div id="tooltip"></div>

  <!-- three.js + postprocessing (r128) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/Pass.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>

<script>
/* ===== Mobile performance switches ===== */
const DPR = Math.min(1.5, window.devicePixelRatio || 1);  // cap DPR
const EDGE_SEGMENTS = 10;   // fewer segments
const HALOS = true;         // set false if still slow
const LABEL_SMART_DISTANCE = 24; // lower = fewer labels visible

/* ===== Globals ===== */
let scene, renderer, camera, composer, renderPass, bloomPass, haloTexture, raycaster, mouse;
let layersByName={}, allNodes=[], edges=[], nodeLabels=[], verticalConnections=[];
let animating=true, labelMode='smart', radius=26, theta=Math.PI/4, phi=Math.PI/4;
let isTouching=false, lastTouches=[], pinchStartDist=0, lastX=0, lastY=0;
let frame=0, updateEvery=2; // throttle work

/* ===== Layers (universes) ===== */
const layers = {
  mcu:   { name:'MCU',                   color:0xff3b30, height: 0 },
  ssu:   { name:'SSU',                   color:0x0a84ff, height: 4.5 },
  raimi: { name:'Raimi',                 color:0xbf5af2, height: 9 },
  asm:   { name:'ASM',                   color:0xff9f0a, height: 13.5 },
  fox:   { name:'Fox/Deadpool',          color:0x34c759, height: 18 },
  anim:  { name:'Animated Spider-Verse', color:0x64d2ff, height: 22.5 }
};
// legend
const legend = document.querySelector('.layer-legend');
for (const k of Object.keys(layers)){
  const row = document.createElement('div'); row.className='layer-item';
  row.innerHTML = '<div class="layer-left"><div class="layer-color"></div><span>'+layers[k].name+'</span></div>';
  row.querySelector('.layer-color').style.background = '#'+layers[k].color.toString(16).padStart(6,'0');
  const cb = document.createElement('input'); cb.type='checkbox'; cb.checked=true;
  cb.addEventListener('change', e=>setLayerOpacity(k, e.target.checked?1:.06));
  row.appendChild(cb); legend.appendChild(row);
}

/* ===== Minimal data ===== */
function N(id, label, layer, x, z, sub=''){ return {id,label,layer,x,z,sub} }
const nodes = [
  N('ex:PeterParker_MCU','Peter Parker','mcu',  0, 0,'Tom Holland'),
  N('ex:PeterParker_Raimi','Peter Parker','raimi', 0, 0,'Tobey Maguire'),
  N('ex:PeterParker_ASM','Peter Parker','asm', 0, 0,'Andrew Garfield'),

  N('ex:MilesMorales','Miles Morales','anim', -3.5, 2.5),
  N('ex:GwenStacy_Spider','Gwen Stacy (Spider-Gwen)','anim', 3.5, 2.5),

  N('ex:Venom','Eddie Brock / Venom','ssu', -3.5,-2),
  N('ex:Morbius','Michael Morbius','ssu',  3.5,-2),

  N('ex:Deadpool','Wade Wilson (Deadpool)','fox', -2.5, 2),
  N('ex:Wolverine','Logan (Wolverine)','fox',  2.5, 2),

  N('ex:NWH','No Way Home','mcu', -6, 1.6),
  N('ex:Raimi2','Spider-Man 2','raimi', 6, 1.2),
  N('ex:ASM2','ASM 2','asm', -6, 1.2),
  N('ex:VenomFilm','Venom','ssu', -6, -1),
  N('ex:MorbiusFilm','Morbius','ssu',  6, -1),
  N('ex:DandW','Deadpool & Wolverine','fox', 0, -1.4),
  N('ex:Across','Across the Spider-Verse','anim', 0, -1.4),

  N('ex:AdrianToomes','Adrian Toomes (Vulture)','mcu', -2, -2.8)
];
const triples = [
  { s:'ex:PeterParker_MCU',   p:'ex:appearsIn', o:'ex:NWH',     layer:'mcu'  },
  { s:'ex:PeterParker_Raimi', p:'ex:appearsIn', o:'ex:Raimi2',  layer:'raimi'},
  { s:'ex:PeterParker_ASM',   p:'ex:appearsIn', o:'ex:ASM2',    layer:'asm'  },
  { s:'ex:Venom',             p:'ex:appearsIn', o:'ex:VenomFilm',   layer:'ssu' },
  { s:'ex:Morbius',           p:'ex:appearsIn', o:'ex:MorbiusFilm', layer:'ssu' },
  { s:'ex:Deadpool',          p:'ex:appearsIn', o:'ex:DandW',   layer:'fox'  },
  { s:'ex:Wolverine',         p:'ex:appearsIn', o:'ex:DandW',   layer:'fox'  },
  { s:'ex:MilesMorales',      p:'ex:appearsIn', o:'ex:Across',  layer:'anim' },
  { s:'ex:GwenStacy_Spider',  p:'ex:appearsIn', o:'ex:Across',  layer:'anim' },
  { s:'ex:AdrianToomes',      p:'ex:appearsIn', o:'ex:NWH',     layer:'mcu'  },
  { s:'ex:AdrianToomes',      p:'ex:cameoIn',   o:'ex:MorbiusFilm', layer:'ssu' }
];
const sharedEntities = [
  { id:'ex:PeterParker_MCU', connectTo:'ex:PeterParker_Raimi' },
  { id:'ex:PeterParker_MCU', connectTo:'ex:PeterParker_ASM' }
];

/* ===== Setup ===== */
function neonMat(color, opacity=.9){
  return new THREE.MeshBasicMaterial({color,transparent:true,opacity,blending:THREE.AdditiveBlending,depthWrite:false});
}
function init(){
  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 1000);
  renderer = new THREE.WebGLRenderer({
    antialias:false, alpha:true, powerPreference:'high-performance', preserveDrawingBuffer:false
  });
  renderer.setPixelRatio(DPR);
  renderer.setSize(innerWidth, innerHeight);
  document.getElementById('canvas-container').appendChild(renderer.domElement);

  composer = new THREE.EffectComposer(renderer);
  renderPass = new THREE.RenderPass(scene, camera);
  bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(innerWidth, innerHeight), 0.55, 0.35, 0.0);
  composer.addPass(renderPass); composer.addPass(bloomPass);

  // Halo sprite texture (cheap)
  const c=document.createElement('canvas'); c.width=c.height=128; const x=c.getContext('2d');
  const g=x.createRadialGradient(64,64,0,64,64,64);
  g.addColorStop(0,'rgba(255,255,255,1)'); g.addColorStop(.5,'rgba(255,255,255,.2)'); g.addColorStop(1,'rgba(255,255,255,0)');
  x.fillStyle=g; x.fillRect(0,0,128,128); haloTexture=new THREE.CanvasTexture(c); haloTexture.minFilter=THREE.LinearFilter;

  raycaster = new THREE.Raycaster(); mouse = new THREE.Vector2();

  build();
  wireUI();
  positionCamera();
  animate();

  // Touch controls
  const cvs = renderer.domElement;
  cvs.addEventListener('touchstart', onTouchStart, {passive:false});
  cvs.addEventListener('touchmove',  onTouchMove,  {passive:false});
  cvs.addEventListener('touchend',   onTouchEnd,   {passive:false});
  // Resize
  window.addEventListener('resize', onResize);
}
function build(){
  // Layer slabs
  for (const key of Object.keys(layers)){
    layersByName[key]=new THREE.Group(); scene.add(layersByName[key]);
    const h = layers[key].height, s=16, t=.14;
    const col = layers[key].color;
    const barMat = neonMat(col,.8);
    const bars = [
      [new THREE.BoxGeometry(s,t,t), [0,h, s/2]],
      [new THREE.BoxGeometry(s,t,t), [0,h,-s/2]],
      [new THREE.BoxGeometry(t,t,s), [ s/2,h,0]],
      [new THREE.BoxGeometry(t,t,s), [-s/2,h,0]],
    ];
    bars.forEach(([g,p])=>{ const m=new THREE.Mesh(g,barMat); m.position.set(...p); scene.add(m); });
    const plane = new THREE.Mesh(new THREE.PlaneGeometry(s,s), new THREE.MeshBasicMaterial({color:0xffffff,transparent:true,opacity:.05,side:THREE.DoubleSide}));
    plane.position.y=h; plane.rotation.x=-Math.PI/2; scene.add(plane);
  }

  // Nodes + labels
  const idx = new Map();
  nodes.forEach(n=>{
    const y = layers[n.layer].height;
    const m = new THREE.Mesh(new THREE.SphereGeometry(.48, 24, 16), neonMat(layers[n.layer].color,.95));
    m.position.set(n.x,y,n.z); m.userData=n; scene.add(m);
    if (HALOS){ const spr=new THREE.Sprite(new THREE.SpriteMaterial({map:haloTexture,color:layers[n.layer].color,transparent:true,blending:THREE.AdditiveBlending})); spr.scale.set(1.8,1.8,1); spr.position.copy(m.position); scene.add(spr); }
    allNodes.push(m); idx.set(n.id,m);

    const d=document.createElement('div'); d.className='label3d';
    d.textContent = n.sub?`${n.label} ‚Äî ${n.sub}`:n.label; d.userData={position:m.position};
    document.body.appendChild(d); nodeLabels.push(d);
  });

  // Edges
  edges.length=0;
  triples.forEach(t=>{
    const s=idx.get(t.s), o=idx.get(t.o); if(!s||!o) return;
    const col=layers[t.layer].color;
    const curve = new THREE.QuadraticBezierCurve3(
      s.position.clone(),
      new THREE.Vector3( (s.position.x+o.position.x)/2, (s.position.y+o.position.y)/2 + 0.8, (s.position.z+o.position.z)/2 ),
      o.position.clone()
    );
    const tube = new THREE.Mesh(new THREE.TubeGeometry(curve, EDGE_SEGMENTS, 0.10, 8, false), neonMat(col,.9));
    scene.add(tube);
    const labelDiv = document.createElement('div'); labelDiv.className='label3d edge-pill';
    labelDiv.innerHTML = `<span>${s.userData.label}</span> <span class="arrow">‚Äî[${t.p}]‚Üí</span> <span>${o.userData.label}</span>`;
    document.body.appendChild(labelDiv);
    edges.push({curve,tube,labelDiv});
  });

  // Shared vertical columns (place at shared x/z of Peter)
  verticalConnections.length=0;
  sharedEntities.forEach(ent=>{
    const a = nodes.find(n=>n.id===ent.id);
    const b = nodes.find(n=>n.id===ent.connectTo);
    if (!a || !b) return;
    const ay=layers[a.layer].height, by=layers[b.layer].height;
    const min=Math.min(ay,by), max=Math.max(ay,by), h=max-min;
    const cyl = new THREE.Mesh(new THREE.CylinderGeometry(.12,.12,h,12), neonMat(0x39FF14,.75));
    cyl.position.set(a.x, min+h/2, a.z); scene.add(cyl); verticalConnections.push(cyl);
  });
}

/* ===== UI & helpers ===== */
function wireUI(){
  const collapseBtn = document.getElementById('collapseBtn');
  collapseBtn.onclick = ()=>{ const p=document.getElementById('info'); const c=p.classList.toggle('collapsed'); collapseBtn.textContent=c?'‚ñ∏':'‚ñæ'; };

  document.getElementById('animBtn').onclick = (e)=>{ animating=!animating; e.currentTarget.setAttribute('aria-pressed',animating) };
  document.getElementById('labelsBtn').onclick = (e)=>{ labelMode = (labelMode==='smart')?'all':(labelMode==='all'?'none':'smart'); e.currentTarget.dataset.mode=labelMode; e.currentTarget.textContent='üè∑Ô∏è Labels: '+(labelMode==='smart'?'Smart':labelMode==='all'?'All':'None'); e.currentTarget.setAttribute('aria-pressed',labelMode!=='none'); };
  document.getElementById('topBtn').onclick = ()=>{ theta=0.0001; radius=30; positionCamera(); };
  document.getElementById('resetBtn').onclick = ()=>{ radius=26; theta=Math.PI/4; phi=Math.PI/4; positionCamera(); };
  document.getElementById('perfBtn').onclick = (e)=>{ const on = e.currentTarget.getAttribute('aria-pressed')!=='true'; e.currentTarget.setAttribute('aria-pressed', on); bloomPass.strength = on?0.55:1.1; };

  document.getElementById('toggle-vertical').onchange = (e)=> verticalConnections.forEach(c=> c.visible = e.target.checked);

  window.addEventListener('mousemove', (e)=>{
    mouse.x=(e.clientX/innerWidth)*2-1; mouse.y=-(e.clientY/innerHeight)*2+1;
  });
}
function setLayerOpacity(name,o){
  // fade only nodes/edges roughly at that height
  const y = layers[name].height;
  allNodes.forEach(n=>{ if (Math.abs(n.position.y - y)<0.6){ n.material.opacity=o; }});
  edges.forEach(e=>{ const my=e.curve.getPoint(.5).y; if (Math.abs(my-y)<1){ e.tube.material.opacity=o; e.labelDiv.style.opacity = o===1?1:.25; }});
}
function positionCamera(){
  const x = radius*Math.sin(theta)*Math.cos(phi),
        y = radius*Math.cos(theta),
        z = radius*Math.sin(theta)*Math.sin(phi);
  if (!camera) return;
  camera.position.set(x,y,z); camera.up.set(0,1,0); camera.lookAt(0,9,0);
}
function updateLabels(){
  const cam=camera;
  nodeLabels.forEach(l=>{
    const p=l.userData?.position; if(!p || labelMode==='none'){ l.style.display='none'; return; }
    if(labelMode==='smart' && cam.position.distanceTo(p) > LABEL_SMART_DISTANCE){ l.style.display='none'; return; }
    const v = p.clone ? p.clone() : new THREE.Vector3(p.x,p.y,p.z);
    v.project(cam);
    if (v.z<-1 || v.z>1){ l.style.display='none'; return; }
    l.style.left = ((v.x*0.5+0.5)*innerWidth) + 'px';
    l.style.top  = ((-v.y*0.5+0.5)*innerHeight) + 'px';
    l.style.display='block';
  });
  edges.forEach(e=>{
    if(labelMode==='none'){ e.labelDiv.style.display='none'; return; }
    const p = e.curve.getPoint(.6).clone().project(cam);
    if (p.z<-1 || p.z>1){ e.labelDiv.style.display='none'; return; }
    e.labelDiv.style.left = ((p.x*0.5+0.5)*innerWidth) + 'px';
    e.labelDiv.style.top  = ((-p.y*0.5+0.5)*innerHeight) + 'px';
    e.labelDiv.style.display='block';
  });
}

/* ===== Touch controls ===== */
function dist(a,b){ return Math.hypot(a.clientX-b.clientX, a.clientY-b.clientY); }
function onTouchStart(e){
  isTouching=true; lastTouches=[...e.touches];
  if (e.touches.length===2){ pinchStartDist = dist(e.touches[0], e.touches[1]); }
  if (e.touches.length===1){ lastX=e.touches[0].clientX; lastY=e.touches[0].clientY; }
  e.preventDefault();
}
function onTouchMove(e){
  if (!isTouching) return;
  if (e.touches.length===1 && lastTouches.length===1){
    const dx = e.touches[0].clientX - lastX;
    const dy = e.touches[0].clientY - lastY;
    phi  -= dx * 0.005;
    theta-= dy * 0.005;
    theta = Math.max(0.0001, Math.min(Math.PI-0.0001, theta));
    lastX = e.touches[0].clientX; lastY=e.touches[0].clientY;
    positionCamera();
  } else if (e.touches.length===2){
    const d = dist(e.touches[0], e.touches[1]);
    const f = d / (pinchStartDist || d);
    radius /= Math.pow(f, 0.25); // gentle zoom
    radius = Math.max(8, Math.min(60, radius));
    pinchStartDist = d;
    positionCamera();
  }
  lastTouches=[...e.touches];
  e.preventDefault();
}
function onTouchEnd(){ isTouching=false; lastTouches=[]; }

/* ===== Loop ===== */
function animate(){
  requestAnimationFrame(animate);

  // light animation; no per-frame geometry rebuild
  if (animating){
    const t=Date.now()*0.001;
    for (let i=0;i<allNodes.length;i++){
      const n=allNodes[i];
      n.position.y = (n.userData.baseY ?? (n.userData.baseY = n.position.y)) + Math.sin(t + i*0.5)*0.04;
    }
  }

  // throttle heavy UI work
  frame=(frame+1)%updateEvery;
  if (frame===0){ updateLabels(); }

  composer.render();
}

/* ===== Resize ===== */
function onResize(){
  renderer.setPixelRatio(DPR);
  renderer.setSize(innerWidth, innerHeight);
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
}

/* ===== Start ===== */
init();
</script>
</body>
</html>
